#################################################################
#                                                               #
#                             UPS                               #
#                                                               #
#################################################################

- alias: "UPS: UPS Charging"
  trigger:
    - platform: state
      entity_id: sensor.cyberpower_status_data
      to: "OL CHRG"
      for:
        minutes: 2
  action:
    - service: notify.admins
      data:
        title: Home Assistant
        message: "System charging. Turning server back on."
  # - service: switch.turn_on
  #   entity_id: switch.omv_nas

- alias: "UPS Discharging - Critical"
  trigger:
    - platform: state
      entity_id: sensor.myups_battery_runtime
  condition:
    - condition: template
      value_template: "{{states('sensor.myups_battery_runtime')|int(0) < 300}}"
  action:
    - service: notify.admins
      data:
        title: Home Assistant
        message: "System battery critical. Safely shutting everything down"
    # - service: switch.turn_on
    #   entity_id: switch.omv_nas
    - delay: "00:00:30"
    - service: shell_command.shutdown_omv
    - service: hassio.host_shutdown

- id: "ups_discharging_conserve_power"
  alias: "UPS Discharging - Conserve power"
  trigger:
    - platform: state
      entity_id: sensor.cyberpower_status_data
      to: "OB DISCHRG"
      for:
        minutes: 5
  action:
    - service: notify.admins
      data:
        title: Home Assistant
        message: "System on battery.  Sleeping NAS"
    # - service: switch.turn_off
    #   entity_id: switch.omv_nas

# # switch:
# #   - platform: command_line
# #     switches:
# #       Mediacenter:
# #         oncmd: sudo etherwake so:me:th:in:ge:ad
# #         offcmd: ssh user@host sudo /sbin/shutdown -h now
# # https://cshire.xyz/scripting-synology-diskstation-remote-shutdowns/

- alias: "UPS: UPS Discharging"
  trigger:
    - platform: state
      entity_id: sensor.cyberpower_status_data
      to: "OB DISCHRG"
      from: "OL"
  action:
    - service: notify.admins
      data:
        title: Home Assistant
        message: "System on battery."
